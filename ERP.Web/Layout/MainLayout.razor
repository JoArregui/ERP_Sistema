@inherits LayoutComponentBase
@using ERP.Web.Services
@inject NotificationService NotificationService
@implements IDisposable

<div class="flex h-screen bg-slate-100 overflow-hidden relative">
    
    @* BARRA LATERAL (Sidebar) *@
    <aside class="w-72 h-full flex-shrink-0 border-r border-slate-200 bg-white shadow-sm z-10">
        <NavMenu />
    </aside>

    @* CONTENIDO DINÁMICO *@
    <main class="flex-1 h-full overflow-y-auto relative">
        <div class="p-8">
            @Body 
        </div>
    </main>

    @* CONTENEDOR DE NOTIFICACIONES (TOASTS SYSTEM) *@
    <div class="fixed bottom-6 right-6 z-[9999] flex flex-col gap-3">
        @foreach (var toast in ActiveNotifications)
        {
            <div class="flex items-center p-4 min-w-[320px] rounded-xl shadow-2xl border-l-4 transform transition-all duration-300 animate-notification @GetToastStyle(toast.Type)">
                <div class="mr-4 text-2xl">
                    @GetIcon(toast.Type)
                </div>
                <div class="flex-1">
                    <p class="font-bold text-xs uppercase tracking-wider opacity-75">@toast.Type.ToString()</p>
                    <p class="text-sm font-medium">@toast.Message</p>
                </div>
                <button @onclick="() => RemoveToast(toast)" class="ml-4 p-1 hover:bg-black/10 rounded-full transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        }
    </div>
</div>

<style>
    @@keyframes notificationIn {
        from { opacity: 0; transform: translateY(20px) scale(0.95); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .animate-notification {
        animation: notificationIn 0.3s ease-out forwards;
    }
</style>

@code {
    private List<ToastModel> ActiveNotifications = new();

    protected override void OnInitialized()
    {
        // Suscripción al servicio global de notificaciones
        NotificationService.OnShow += HandleNotification;
    }

    private void HandleNotification(string message, NotificationType type)
    {
        var newToast = new ToastModel { Message = message, Type = type };
        ActiveNotifications.Add(newToast);
        
        // Refrescar UI
        StateHasChanged();

        // Auto-eliminar después de 5 segundos para no saturar la pantalla
        _ = Task.Delay(5000).ContinueWith(_ => 
        {
            RemoveToast(newToast);
            InvokeAsync(StateHasChanged);
        });
    }

    private void RemoveToast(ToastModel toast)
    {
        if (ActiveNotifications.Contains(toast))
        {
            ActiveNotifications.Remove(toast);
        }
    }

    private string GetToastStyle(NotificationType type) => type switch
    {
        NotificationType.Success => "bg-slate-900 text-emerald-400 border-emerald-500",
        NotificationType.Error => "bg-slate-900 text-rose-400 border-rose-500",
        NotificationType.Warning => "bg-slate-900 text-amber-400 border-amber-500",
        _ => "bg-slate-900 text-blue-400 border-blue-500"
    };

    private string GetIcon(NotificationType type) => type switch
    {
        NotificationType.Success => "󰄬",
        NotificationType.Error => "󰅖",
        NotificationType.Warning => "󰀪",
        _ => "󰋽"
    };

    public void Dispose()
    {
        // Limpieza de evento para evitar fugas de memoria
        NotificationService.OnShow -= HandleNotification;
    }

    public class ToastModel
    {
        public string Message { get; set; } = string.Empty;
        public NotificationType Type { get; set; }
        public DateTime Created { get; set; } = DateTime.Now;
    }
}