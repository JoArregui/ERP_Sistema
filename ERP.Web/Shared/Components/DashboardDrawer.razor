@using ERP.Domain.DTOs
@using System.Net.Http.Json
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject HttpClient Http

@if (isOpen)
{
    <div class="fixed inset-0 z-[150] overflow-hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" @onclick="Close"></div>

        <div class="absolute inset-y-0 right-0 w-full max-w-md flex">
            <div class="h-full w-full bg-white shadow-2xl flex flex-col animate-slide-left border-l border-slate-200">
                
                @* HEADER *@
                <div class="p-6 border-b bg-slate-50/50">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-black italic tracking-tighter text-slate-900 uppercase">@Detalle?.Titulo</h3>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Gestión de Reportes</p>
                        </div>
                        <button @onclick="Close" class="h-8 w-8 flex items-center justify-center hover:bg-slate-200 rounded-lg transition-all">
                            <i class="bi bi-x-lg text-slate-600"></i>
                        </button>
                    </div>

                    @* ACCIONES DE EXPORTACIÓN *@
                    <div class="flex gap-2">
                        <button @onclick="ExportExcel" class="flex-1 py-2 bg-emerald-100 text-emerald-700 rounded-xl text-[10px] font-black uppercase tracking-wider hover:bg-emerald-200 transition-all flex items-center justify-center gap-2">
                            <i class="bi bi-file-earmark-excel-fill"></i> Excel
                        </button>
                        <button @onclick="ExportPdf" class="flex-1 py-2 bg-rose-100 text-rose-700 rounded-xl text-[10px] font-black uppercase tracking-wider hover:bg-rose-200 transition-all flex items-center justify-center gap-2">
                            <i class="bi bi-file-earmark-pdf-fill"></i> PDF
                        </button>
                    </div>

                    @* PANEL DE ENVÍO POR EMAIL *@
                    <div class="mt-4 p-3 bg-white rounded-2xl border border-slate-200 shadow-sm">
                        <p class="text-[9px] font-black text-slate-400 uppercase mb-2 tracking-widest">Envío automático por Mail</p>
                        <div class="flex gap-2">
                            <input type="email" @bind="emailDestino" 
                                   class="flex-1 px-3 py-2 bg-slate-50 border border-slate-100 rounded-xl text-xs focus:ring-2 focus:ring-rose-500 outline-none transition-all" 
                                   placeholder="ejemplo@empresa.com" />
                            
                            <button @onclick="EnviarPorEmail" disabled="@isSending"
                                    class="px-4 py-2 bg-slate-900 text-white rounded-xl text-xs font-bold hover:bg-rose-600 transition-all flex items-center justify-center min-w-[44px]">
                                @if (isSending) {
                                    <div class="h-3 w-3 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                } else {
                                    <i class="bi bi-send-fill"></i>
                                }
                            </button>
                        </div>
                        @if (!string.IsNullOrEmpty(statusMessage))
                        {
                            <p class="text-[9px] mt-2 font-bold text-emerald-600 italic">@statusMessage</p>
                        }
                    </div>
                </div>

                @* BARRA DE BÚSQUEDA *@
                <div class="p-4 border-b bg-white">
                    <div class="relative">
                        <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" class="w-full pl-10 pr-4 py-2 bg-slate-100 border-none rounded-xl text-sm focus:ring-2 focus:ring-rose-500 transition-all" 
                               placeholder="Filtrar para exportar..." @bind="searchTerm" @bind:event="oninput" />
                    </div>
                </div>

                @* CONTENIDO DE LA LISTA *@
                <div class="flex-1 overflow-y-auto p-4 space-y-3">
                    @if (Detalle == null)
                    {
                        <div class="flex flex-col justify-center items-center h-40">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-rose-500"></div>
                        </div>
                    }
                    else
                    {
                        @foreach (var item in FilteredItems)
                        {
                            <div class="p-4 rounded-2xl border border-slate-100 bg-white hover:border-slate-300 transition-all group">
                                <div class="flex justify-between items-start">
                                    <div class="pr-4">
                                        <p class="font-bold text-slate-900 text-sm leading-tight">@item.Principal</p>
                                        <p class="text-[10px] text-slate-400 font-mono">@item.Secundario</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xs font-black text-rose-600">@item.Valor</p>
                                        <button @onclick="() => IrADetalle(item)" class="mt-2 text-[9px] font-bold text-slate-400 hover:text-slate-900 underline uppercase tracking-tighter">
                                            Ver Ficha <i class="bi bi-arrow-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
}

<style>
    .animate-slide-left {
        animation: slideLeft 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @@keyframes slideLeft {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
</style>

@code {
    private bool isOpen = false;
    private string searchTerm = "";
    private string emailDestino = "";
    private string statusMessage = "";
    private bool isSending = false;
    private DashboardDetalleDTO? Detalle;

    private IEnumerable<ItemDetalle> FilteredItems => 
        string.IsNullOrWhiteSpace(searchTerm) 
            ? Detalle?.Items ?? new List<ItemDetalle>()
            : Detalle?.Items.Where(i => i.Principal.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) || 
                                       i.Secundario.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ?? new List<ItemDetalle>();

    public async Task Open(string tipo, HttpClient http)
    {
        isOpen = true;
        Detalle = null;
        searchTerm = "";
        emailDestino = "";
        statusMessage = "";
        Detalle = await http.GetFromJsonAsync<DashboardDetalleDTO>($"api/dashboard/detalle/{tipo}");
        StateHasChanged();
    }

    private async Task EnviarPorEmail()
    {
        if (string.IsNullOrWhiteSpace(emailDestino) || Detalle == null) return;

        isSending = true;
        statusMessage = "Enviando...";
        StateHasChanged();

        try 
        {
            var request = new EnvioReporteDTO {
                Titulo = Detalle.Titulo,
                Destinatario = emailDestino,
                Items = FilteredItems.ToList()
            };

            var response = await Http.PostAsJsonAsync("api/dashboard/enviar-reporte-email", request);
            
            if (response.IsSuccessStatusCode) {
                statusMessage = "✓ Reporte enviado con éxito";
                emailDestino = "";
            } else {
                statusMessage = "Error al enviar";
            }
        }
        catch (Exception) {
            statusMessage = "Error de conexión";
        }
        finally {
            isSending = false;
            StateHasChanged();
        }
    }

    private async Task ExportExcel()
    {
        var data = FilteredItems.Select(x => new { Concepto = x.Principal, Ref = x.Secundario, Cantidad_Importe = x.Valor });
        await JS.InvokeVoidAsync("exportToExcel", data, $"Reporte_{DateTime.Now:yyyyMMdd}");
    }

    private async Task ExportPdf()
    {
        var headers = new[] { "Concepto", "Referencia / Cliente", "Valor" };
        var data = FilteredItems.Select(x => new[] { x.Principal, x.Secundario, x.Valor }).ToArray();
        await JS.InvokeVoidAsync("exportToPdf", Detalle?.Titulo ?? "Reporte", headers, data, $"Reporte_{DateTime.Now:yyyyMMdd}");
    }

    private void IrADetalle(ItemDetalle item)
    {
        isOpen = false;
        string ruta = item.TipoEnlace == "articulo" ? $"/inventario/articulos/editar/{item.IdRelacionado}" : $"/ventas/facturas/detalle/{item.IdRelacionado}";
        Navigation.NavigateTo(ruta);
    }

    private void Close() => isOpen = false;
}