@page "/login"
@layout EmptyLayout
@using ERP.Domain.Dtos
@using ERP.Web.Services
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService

<div class="min-h-screen w-full flex items-center justify-center bg-[#020617] p-6">
    @* TARJETA PRINCIPAL *@
    <div class="w-full max-w-md bg-[#0f172a] rounded-3xl shadow-2xl border border-slate-800/50 p-8">
        
        @* ENCABEZADO / LOGO *@
        <div class="flex flex-col items-center mb-10">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white text-3xl font-black shadow-xl shadow-blue-500/20 mb-4 ring-1 ring-white/20">
                E
            </div>
            <h1 class="text-2xl font-black text-white tracking-tight uppercase">Bienvenido al <span class="text-blue-500">ERP</span></h1>
            <p class="text-slate-500 text-xs font-bold tracking-[0.2em] mt-2 uppercase">Industrial Hub v2026</p>
        </div>

        @* FORMULARIO *@
        <EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />

            <div class="space-y-6">
                @* CAMPO: EMAIL *@
                <div>
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 ml-1">Correo Electrónico</label>
                    <div class="relative">
                        <i class="bi bi-envelope absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        <InputText @bind-Value="loginModel.Email" 
                                   class="w-full bg-slate-900/50 border border-slate-800 text-white pl-12 pr-4 py-3 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all placeholder:text-slate-700" 
                                   placeholder="usuario@empresa.com" />
                    </div>
                    <ValidationMessage For="@(() => loginModel.Email)" class="text-red-500 text-[10px] mt-1 font-bold" />
                </div>

                @* CAMPO: PASSWORD *@
                <div>
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 ml-1">Contraseña</label>
                    <div class="relative">
                        <i class="bi bi-shield-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        <InputText @bind-Value="loginModel.Password" type="password"
                                   class="w-full bg-slate-900/50 border border-slate-800 text-white pl-12 pr-4 py-3 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all placeholder:text-slate-700" 
                                   placeholder="••••••••" />
                    </div>
                    <ValidationMessage For="@(() => loginModel.Password)" class="text-red-500 text-[10px] mt-1 font-bold" />
                </div>

                @* MENSAJE DE ERROR LOCAL *@
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="bg-red-500/10 border border-red-500/20 text-red-500 text-[11px] p-3 rounded-xl flex items-center gap-2">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <span>@errorMessage</span>
                    </div>
                }

                @* BOTÓN ACCESO *@
                <button type="submit" disabled="@isSubmitting"
                        class="w-full bg-blue-600 hover:bg-blue-500 disabled:bg-slate-800 text-white font-black text-[11px] uppercase tracking-[0.2em] py-4 rounded-xl shadow-lg shadow-blue-900/20 transition-all flex items-center justify-center gap-2">
                    @if (isSubmitting)
                    {
                        <div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                        <span>Verificando...</span>
                    }
                    else
                    {
                        <span>Entrar al Sistema</span>
                        <i class="bi bi-arrow-right"></i>
                    }
                </button>
            </div>
        </EditForm>

        @* FOOTER LOGIN *@
        <div class="mt-10 text-center">
            <p class="text-slate-600 text-[10px] font-medium tracking-wide">
                &copy; 2026 ERP Industrial. Todos los derechos reservados.
            </p>
        </div>
    </div>
</div>

@code {
    private LoginDto loginModel = new LoginDto();
    private bool isSubmitting = false;
    private string? errorMessage;

    private async Task HandleLogin()
    {
        isSubmitting = true;
        errorMessage = null;

        try
        {
            AuthResponseDto? result = await AuthService.Login(loginModel);

            // Corregido: Comparación segura de objetos
            if (result is not null && !string.IsNullOrEmpty(result.Token))
            {
                NavigationManager.NavigateTo("");
            }
            else
            {
                errorMessage = "Credenciales incorrectas o usuario inactivo.";
                
                // Corregido: Ajustado a la firma de tu NotificationService (2 argumentos: mensaje y tipo)
                // Si tu NotificationType es un Enum, asegúrate de que esté accesible.
                NotificationService.ShowNotification("Credenciales inválidas", NotificationType.Error);
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error de conexión con el servidor.";
            Console.WriteLine($"Error en Login: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }
}