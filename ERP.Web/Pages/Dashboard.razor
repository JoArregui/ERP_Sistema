@page "/dashboard"
@using ERP.Domain.DTOs
@using ERP.Web.Shared.Components
@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation

<style>
    @@media print {
        .no-print, .sidebar, .nav-menu, button { display: none !important; }
        .min-h-screen { background-color: white !important; }
        .p-8 { padding: 0 !important; }
        * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    }
    
    .data-update-flash {
        animation: flash 1.5s ease-out;
    }
    @@keyframes flash {
        0% { background-color: rgba(16, 185, 129, 0.15); }
        100% { background-color: transparent; }
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
</style>

<div class="p-8 bg-slate-50 min-h-screen @(isUpdating ? "data-update-flash" : "")">
    
    @* --- CABECERA --- *@
    <div class="flex justify-between items-end mb-10">
        <div>
            <div class="flex items-center gap-3">
                <h1 class="text-5xl font-black text-slate-900 tracking-tighter italic uppercase">Business Insights</h1>
                @if (hubConnection?.State == HubConnectionState.Connected)
                {
                    <span class="flex h-3 w-3 relative">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
                    </span>
                }
            </div>
            <p class="text-slate-400 font-bold uppercase text-[10px] tracking-[0.3em]">Live ERP Intelligence</p>
        </div>
        <div class="flex gap-3 no-print">
            <button @onclick="ImprimirInforme" class="px-6 py-3 bg-white border border-slate-200 rounded-2xl font-bold text-slate-600 hover:bg-slate-50 transition-all flex items-center gap-2 shadow-sm active:scale-95">
                <i class="bi bi-printer"></i> Exportar PDF
            </button>
        </div>
    </div>

    @if (Dto is null)
    {
        <div class="flex flex-col justify-center items-center p-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p class="text-slate-400 font-bold italic animate-pulse">Sincronizando flujo de datos...</p>
        </div>
    }
    else
    {
        @* --- ESTADÍSTICAS --- *@
        <DashboardStats 
            TotalVentas="@Dto.TotalVentas" 
            TotalPendiente="@Dto.ImportePendienteCobro"
            BeneficioEstimado="@Dto.BeneficioNeto"
            CantidadDocumentos="@Dto.FacturasPendientesCobro" />

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
            @* --- GRÁFICO --- *@
            <div class="lg:col-span-2">
                <GraficoVentas Datos="@Dto.VentasMensuales" />
            </div>

            @* --- PANEL DE RIESGOS --- *@
            <div class="flex flex-col gap-6">
                <div class="bg-rose-500 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden group">
                    <h4 class="text-2xl font-black italic tracking-tighter mb-6">ALERTA DE RIESGO</h4>
                    <div class="space-y-4 relative z-10">
                        <div class="glass-card p-4 rounded-2xl cursor-pointer hover:bg-white/20 transition-all"
                             @onclick='() => NavegarADetalle("stock-bajo")'>
                            <span class="block text-[10px] font-black uppercase opacity-70 mb-1 tracking-widest">Stock Bajo Mínimos</span>
                            <div class="flex items-center justify-between">
                                <span class="text-3xl font-black">@Dto.ArticulosStockBajo</span>
                                <i class="bi bi-chevron-right"></i>
                            </div>
                        </div>

                        <div class="glass-card p-4 rounded-2xl cursor-pointer hover:bg-white/20 transition-all"
                             @onclick='() => NavegarADetalle("vencimientos")'>
                            <span class="block text-[10px] font-black uppercase opacity-70 mb-1 tracking-widest">Vencimientos Impagados</span>
                            <div class="flex items-center justify-between">
                                <span class="text-3xl font-black">@Dto.FacturasVencidas</span>
                                <i class="bi bi-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@* --- COMPONENTES AUXILIARES --- *@
<ToastNotification @ref="toast" />
<DashboardDrawer @ref="drawer" />

@code {
    private DashboardDTO? Dto;
    private HubConnection? hubConnection;
    private bool isUpdating = false;
    
    private ToastNotification? toast; 
    private DashboardDrawer? drawer;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();

        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/dashboardHub"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On("ReceiveDashboardUpdate", async () =>
        {
            isUpdating = true;
            StateHasChanged();
            
            await CargarDatos();
            
            if (toast is not null)
            {
                await toast.Show("Información actualizada al instante");
            }
            
            isUpdating = false;
            StateHasChanged();
        });

        try 
        {
            await hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalR Error: {ex.Message}");
        }
    }

    private async Task CargarDatos()
    {
        try {
            Dto = await Http.GetFromJsonAsync<DashboardDTO>("api/dashboard/resumen-financiero");
        } catch (Exception ex) {
            Console.WriteLine($"Error HTTP: {ex.Message}");
        }
    }

    private async Task NavegarADetalle(string tipo)
    {
        if (drawer != null)
        {
            await drawer.Open(tipo, Http);
        }
    }

    private async Task ImprimirInforme() => await JS.InvokeVoidAsync("printWindow");

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}