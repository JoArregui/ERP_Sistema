@page "/rrhh/kiosko"
@layout EmptyLayout
@using ERP.Domain.Entities
@inject HttpClient Http
@inject IJSRuntime JS
@implements IDisposable

<div class="fixed inset-0 bg-[#020617] bg-[radial-gradient(circle_at_top,_var(--tw-gradient-stops))] from-blue-900/20 via-[#020617] to-[#020617] flex flex-col items-center justify-center p-6 font-sans">
    
    @* RELOJ Y LOGO *@
    <div class="absolute top-12 text-center">
        <div class="text-5xl font-black text-white tracking-tighter mb-2">@horaActual</div>
        <div class="text-[10px] font-black text-blue-500 uppercase tracking-[0.4em]">@fechaActual</div>
    </div>

    @* CONTENEDOR PRINCIPAL *@
    <div class="w-full max-w-md bg-[#0f172a]/40 backdrop-blur-xl border border-slate-800 p-10 rounded-[40px] shadow-3xl text-center">
        <div class="w-16 h-16 bg-blue-600 rounded-2xl mx-auto mb-6 flex items-center justify-center text-white text-3xl font-black shadow-lg shadow-blue-500/20">E</div>
        
        <h2 class="text-white text-2xl font-black tracking-tighter uppercase mb-1">Terminal de Fichaje</h2>
        <p class="text-slate-500 font-bold tracking-[0.2em] text-[10px] mb-8">INTRODUZCA PIN PERSONAL</p>

        @* INDICADORES DE PIN *@
        <div class="mb-10 flex justify-center gap-6">
            @for (int i = 0; i < 4; i++) {
                <div class="@(pinActual.Length > i ? "bg-blue-500 scale-125 shadow-[0_0_15px_rgba(59,130,246,0.8)]" : "bg-slate-800") w-3 h-3 rounded-full transition-all duration-200"></div>
            }
        </div>

        @* TECLADO *@
        <div class="grid grid-cols-3 gap-4 mb-10">
            @foreach (var num in new[] { "1", "2", "3", "4", "5", "6", "7", "8", "9", "C", "0", "‚Üê" }) {
                <button @onclick="() => TecladoInput(num)" 
                        class="h-16 rounded-2xl bg-slate-900/50 border border-slate-800 text-white text-xl font-black hover:bg-blue-600 hover:border-blue-500 transition-all active:scale-90 shadow-sm shadow-black/50">
                    @num
                </button>
            }
        </div>

        @* ACCIONES *@
        <div class="grid grid-cols-2 gap-4">
            <button @onclick='() => IntentarFichaje("entrada")' 
                    disabled="@(pinActual.Length < 4 || procesando)"
                    class="group relative overflow-hidden bg-emerald-600 disabled:bg-slate-800 disabled:opacity-50 text-white py-5 rounded-2xl font-black text-xs uppercase tracking-widest transition-all shadow-lg shadow-emerald-900/20">
                <span class="relative z-10"><i class="bi bi-box-arrow-in-right mr-2"></i>Entrada</span>
            </button>
            
            <button @onclick='() => IntentarFichaje("salida")' 
                    disabled="@(pinActual.Length < 4 || procesando)"
                    class="bg-rose-600 disabled:bg-slate-800 disabled:opacity-50 text-white py-5 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl shadow-rose-900/20">
                <i class="bi bi-box-arrow-left mr-2"></i>Salida
            </button>
        </div>
    </div>

    @* FEEDBACK FLOTANTE *@
    @if (!string.IsNullOrEmpty(mensajeStatus))
    {
        <div class="fixed bottom-12 animate-bounce bg-slate-900 border border-blue-500/30 px-8 py-4 rounded-2xl shadow-2xl">
            <p class="text-white font-bold text-sm">@mensajeStatus</p>
        </div>
    }
</div>

@code {
    private string pinActual = "";
    private string horaActual = "";
    private string fechaActual = "";
    private string mensajeStatus = "";
    private bool procesando = false;
    private System.Timers.Timer? timer;

    protected override void OnInitialized()
    {
        ActualizarReloj();
        timer = new System.Timers.Timer(1000);
        timer.Elapsed += (s, e) => { ActualizarReloj(); InvokeAsync(StateHasChanged); };
        timer.Start();
    }

    private void ActualizarReloj()
    {
        horaActual = DateTime.Now.ToString("HH:mm:ss");
        fechaActual = DateTime.Now.ToString("dd MMMM yyyy").ToUpper();
    }

    private void TecladoInput(string key) {
        if (key == "C") pinActual = "";
        else if (key == "‚Üê") { if (pinActual.Length > 0) pinActual = pinActual[..^1]; }
        else if (pinActual.Length < 4) pinActual += key;
        
        mensajeStatus = "";
    }

    private async Task IntentarFichaje(string tipo) {
        procesando = true;
        mensajeStatus = "üîÑ PROCESANDO...";

        try 
        {
            var empleados = await Http.GetFromJsonAsync<List<Empleado>>("api/empleados");
            var emp = empleados?.FirstOrDefault(e => e.PinAcceso == pinActual);

            if (emp == null)
            {
                mensajeStatus = "‚ùå PIN INCORRECTO";
                pinActual = "";
            }
            else 
            {
                var request = new { EmpleadoId = emp.Id, Pin = pinActual };
                var response = await Http.PostAsJsonAsync($"api/fichaje/{tipo}", request);

                if (response.IsSuccessStatusCode)
                {
                    mensajeStatus = $"‚úÖ {tipo.ToUpper()} OK: {emp.Nombre}";
                    pinActual = "";
                    StateHasChanged();
                    await Task.Delay(3000);
                    mensajeStatus = "";
                }
                else
                {
                    mensajeStatus = "‚ö†Ô∏è ERROR AL REGISTRAR";
                }
            }
        }
        catch (Exception) // Corregido: se elimina 'ex' para evitar CS0168
        {
            mensajeStatus = "‚ùó ERROR DE CONEXI√ìN";
        }
        finally 
        {
            procesando = false;
            pinActual = "";
        }
    }

    public void Dispose()
    {
        timer?.Stop();
        timer?.Dispose();
    }
}