@page "/stock/ajuste"
@using ERP.Domain.Entities
@using ERP.Domain.DTOs
@using System.Net.Http.Json
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Ajuste de Inventario</PageTitle>

<div class="container-fluid">
    @* --- CABECERA ESTILO ERP MODERNO --- *@
    <div class="d-flex justify-content-between align-items-center my-4">
        <div>
            <h1 class="text-3xl font-black text-slate-900 tracking-tighter italic uppercase mb-0">AJUSTE DE STOCK</h1>
            <p class="text-slate-500 text-[10px] font-mono uppercase tracking-widest">Corrección de inventario físico y regularizaciones</p>
        </div>
        <div class="bg-blue-600 text-white px-4 py-2 rounded-2xl shadow-lg shadow-blue-200">
            <span class="text-[10px] uppercase font-bold d-block opacity-75">Terminal Activo</span>
            <span class="font-black">WEB-ADMIN-01</span>
        </div>
    </div>

    <div class="row">
        @* --- COLUMNA IZQUIERDA: BUSCADOR --- *@
        <div class="col-md-5">
            <div class="card border-0 shadow-xl rounded-3xl overflow-hidden mb-4">
                <div class="card-body p-4">
                    <label class="text-[10px] font-black uppercase text-blue-600 mb-2 d-block">Buscar Artículo (Código o Nombre)</label>
                    <div class="input-group mb-3">
                        <span class="input-group-text bg-slate-50 border-0 rounded-start-2xl">
                            <i class="bi bi-search text-slate-400"></i>
                        </span>
                        <input type="text" class="form-control form-control-lg bg-slate-50 border-0 rounded-end-2xl text-sm font-bold" 
                               placeholder="Escriba para filtrar..." @oninput="BuscarArticulos" />
                    </div>

                    <div class="list-group list-group-flush overflow-auto" style="max-height: 500px;">
                        @if (articulosFiltrados == null)
                        {
                            <div class="text-center py-5">
                                <div class="spinner-border text-slate-200" role="status"></div>
                            </div>
                        }
                        else
                        {
                            @foreach (var art in articulosFiltrados)
                            {
                                <button type="button" @onclick="() => SeleccionarArticulo(art)"
                                        class="list-group-item list-group-item-action border-0 rounded-2xl mb-2 p-3 transition-all @(articuloSeleccionado?.Id == art.Id ? "bg-slate-900 text-white" : "bg-slate-50 text-slate-700")">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="font-black italic uppercase">@art.Codigo</div>
                                            <div class="text-xs opacity-75">@art.Descripcion</div>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge @(art.Stock < 0 ? "bg-red-500" : "bg-blue-500") rounded-pill">@art.Stock.ToString("N2")</span>
                                        </div>
                                    </div>
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>

        @* --- COLUMNA DERECHA: FORMULARIO DE AJUSTE --- *@
        <div class="col-md-7">
            @if (articuloSeleccionado != null)
            {
                <div class="card border-0 shadow-2xl rounded-3xl animate__animated animate__fadeInRight">
                    <div class="card-header bg-slate-900 text-white p-4 border-0">
                        <h5 class="mb-0 font-black uppercase italic tracking-tighter">Detalles del Ajuste</h5>
                    </div>
                    <div class="card-body p-5">
                        <div class="row mb-5 text-center">
                            <div class="col-6 border-end">
                                <span class="text-[10px] uppercase font-bold text-slate-400 d-block">Stock en Sistema</span>
                                <span class="text-4xl font-black text-slate-900">@articuloSeleccionado.Stock.ToString("N2")</span>
                            </div>
                            <div class="col-6">
                                <span class="text-[10px] uppercase font-bold text-blue-600 d-block">Diferencia</span>
                                <span class="text-4xl font-black @(CalcularDiferencia() >= 0 ? "text-green-500" : "text-red-500")">
                                    @(CalcularDiferencia() > 0 ? "+" : "")@CalcularDiferencia().ToString("N2")
                                </span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="text-[10px] font-black uppercase text-slate-500 mb-2 d-block text-center">Nuevo Stock Físico (Contado)</label>
                            <div class="d-flex align-items-center justify-content-center">
                                <button class="btn btn-outline-slate btn-lg rounded-circle border-2" @onclick="() => ajuste.NuevoStock--">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <input type="number" class="form-control form-control-lg border-0 text-center font-black mx-3 text-5xl" 
                                       style="width: 200px;" @bind="ajuste.NuevoStock" @bind:event="oninput" />
                                <button class="btn btn-outline-slate btn-lg rounded-circle border-2" @onclick="() => ajuste.NuevoStock++">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label class="text-[10px] font-black uppercase text-slate-500 mb-2 d-block">Motivo del ajuste</label>
                            <textarea class="form-control rounded-2xl border-2 border-slate-100 p-3 text-sm" 
                                      rows="3" @bind="ajuste.Motivo" placeholder="Ej: Rotura, error de conteo, regularización anual..."></textarea>
                        </div>

                        <button class="btn btn-slate-900 w-100 py-4 rounded-2xl text-white font-black uppercase tracking-widest shadow-xl transition-all hover:bg-blue-600"
                                @onclick="ProcesarAjuste" disabled="@isProcessing">
                            @if (isProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span> <span>Procesando...</span>
                            }
                            else
                            {
                                <span>Confirmar Ajuste de Stock</span>
                            }
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="h-100 d-flex flex-column align-items-center justify-content-center bg-slate-50 border-2 border-dashed border-slate-200 rounded-3xl p-5">
                    <i class="bi bi-box-seam text-slate-200 display-1 mb-4"></i>
                    <p class="text-slate-400 font-bold uppercase tracking-widest text-xs">Seleccione un artículo para comenzar el ajuste</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<Articulo>? todosLosArticulos;
    private List<Articulo>? articulosFiltrados;
    private Articulo? articuloSeleccionado;
    private AjusteStockDTO ajuste = new();
    private bool isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        todosLosArticulos = await Http.GetFromJsonAsync<List<Articulo>>("api/articulos");
        articulosFiltrados = todosLosArticulos;
    }

    private void BuscarArticulos(ChangeEventArgs e)
    {
        var texto = e.Value?.ToString()?.ToLower() ?? "";
        articulosFiltrados = todosLosArticulos?
            .Where(a => a.Codigo.ToLower().Contains(texto) || a.Descripcion.ToLower().Contains(texto))
            .ToList();
    }

    private void SeleccionarArticulo(Articulo art)
    {
        articuloSeleccionado = art;
        ajuste = new AjusteStockDTO 
        { 
            ArticuloId = art.Id, 
            NuevoStock = art.Stock, 
            TerminalId = "WEB-ADMIN-01" 
        };
    }

    private decimal CalcularDiferencia() => ajuste.NuevoStock - (articuloSeleccionado?.Stock ?? 0);

    private async Task ProcesarAjuste()
    {
        if (articuloSeleccionado == null) return;
        
        isProcessing = true;
        var response = await Http.PostAsJsonAsync("api/stock/ajuste-manual", ajuste);

        if (response.IsSuccessStatusCode)
        {
            // Actualizamos localmente para reflejar el cambio sin recargar todo
            articuloSeleccionado.Stock = ajuste.NuevoStock;
            
            // Notificación visual (opcional con JS o Toast)
            await JS.InvokeVoidAsync("alert", "Inventario actualizado correctamente");
            
            articuloSeleccionado = null; // Limpiamos selección
            await OnInitializedAsync(); // Recargamos la lista principal
        }
        
        isProcessing = false;
    }
}