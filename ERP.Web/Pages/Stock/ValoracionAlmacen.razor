@page "/stock/valoracion"
@using ERP.Domain.DTOs
@using System.Net.Http.Json
@inject HttpClient Http

<PageTitle>Valoración de Almacén</PageTitle>

<div class="container-fluid">
    <div class="my-4">
        <h1 class="text-4xl font-black text-slate-900 tracking-tighter italic uppercase">VALORACIÓN DE ACTIVOS</h1>
        <p class="text-slate-500 font-mono text-sm">Cálculo en tiempo real basado en PMP (Precio Medio Ponderado)</p>
    </div>

    @if (data == null)
    {
        <div class="d-flex justify-content-center my-5">
            <div class="spinner-grow text-primary" role="status"></div>
        </div>
    }
    else
    {
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="bg-slate-900 text-white p-5 rounded-3xl shadow-2xl border-b-8 border-blue-600">
                    <label class="text-[10px] font-bold uppercase tracking-[0.2em] text-blue-400 mb-2 d-block">Valor Total Inventario</label>
                    <h2 class="text-5xl font-black tracking-tighter">@data.ValorTotalAlmacen.ToString("C0")</h2>
                    <div class="mt-4 pt-4 border-t border-slate-800 flex justify-between items-center">
                        <span class="text-slate-400 text-xs">Actualizado ahora mismo</span>
                        <i class="bi bi-currency-euro text-blue-500 fs-4"></i>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="bg-white p-5 rounded-3xl shadow-xl border border-slate-100">
                    <label class="text-[10px] font-bold uppercase tracking-[0.2em] text-slate-400 mb-2 d-block">Unidades Físicas</label>
                    <h2 class="text-5xl font-black text-slate-900 tracking-tighter">@data.CantidadTotalUnidades.ToString("N0")</h2>
                    <div class="mt-4 pt-4 border-t border-slate-100 flex justify-between items-center">
                        <span class="text-slate-500 text-xs">Total de ítems en estantería</span>
                        <i class="bi bi-box-seam text-slate-400 fs-4"></i>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="bg-white p-5 rounded-3xl shadow-xl border border-slate-100">
                    <label class="text-[10px] font-bold uppercase tracking-[0.2em] text-slate-400 mb-2 d-block">Referencias Activas</label>
                    <h2 class="text-5xl font-black text-slate-900 tracking-tighter">@data.TotalArticulosDiferentes</h2>
                    <div class="mt-4 pt-4 border-t border-slate-100 flex justify-between items-center">
                        <span class="text-slate-500 text-xs">SKUs con stock positivo</span>
                        <i class="bi bi-tags text-slate-400 fs-4"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
                    <div class="p-4 bg-slate-50 border-b border-slate-100">
                        <h3 class="text-sm font-black uppercase tracking-widest text-slate-700 m-0">Top 5 Inversión por Producto</h3>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-slate-900 text-white text-[10px] uppercase font-bold tracking-widest">
                                <tr>
                                    <th class="px-5 py-4">Referencia</th>
                                    <th class="px-5 py-4">Descripción</th>
                                    <th class="px-5 py-4 text-center">Stock</th>
                                    <th class="px-5 py-4 text-end">PMP</th>
                                    <th class="px-5 py-4 text-end">Valor Total</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                @foreach (var art in data.TopArticulosMasValiosos)
                                {
                                    <tr>
                                        <td class="px-5 py-4 font-mono text-xs text-blue-600 font-bold">@art.Codigo</td>
                                        <td class="px-5 py-4 font-bold text-slate-800">@art.Descripcion</td>
                                        <td class="px-5 py-4 text-center">
                                            <span class="px-3 py-1 bg-slate-100 rounded-full font-black text-xs">@art.Stock</span>
                                        </td>
                                        <td class="px-5 py-4 text-end text-slate-500">@art.PMP.ToString("N2")€</td>
                                        <td class="px-5 py-4 text-end">
                                            <span class="text-lg font-black text-slate-900">@art.ValorTotal.ToString("C2")</span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private ValoracionStockDTO? data;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            data = await Http.GetFromJsonAsync<ValoracionStockDTO>("api/stock/valoracion-dashboard");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando dashboard: {ex.Message}");
        }
    }
}