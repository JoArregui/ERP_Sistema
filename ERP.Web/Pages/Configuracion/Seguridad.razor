@page "/configuracion/seguridad"
@using ERP.Domain.Dtos
@inject HttpClient Http
@inject IJSRuntime JS

<div class="container-fluid p-4 animate__animated animate__fadeIn">
    @* --- CABECERA DE ALTO IMPACTO --- *@
    <div class="row align-items-center mb-4">
        <div class="col-md-8">
            <h2 class="fw-bold text-dark m-0 display-6">Seguridad del Sistema</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-muted">Inicio</a></li>
                    <li class="breadcrumb-item active fw-semibold text-primary">Configuración de Accesos</li>
                </ol>
            </nav>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-primary btn-lg shadow rounded-3 px-4 py-2 border-0" @onclick="MostrarModalNuevoUsuario" style="background: linear-gradient(45deg, #1a237e, #283593);">
                <i class="bi bi-person-plus-fill me-2"></i> REGISTRAR OPERADOR
            </button>
        </div>
    </div>

    @* --- TARJETAS DE ESTADO (ROLES) --- *@
    <div class="row g-3 mb-4">
        @if (roles == null)
        {
            @for (int i = 0; i < 4; i++) {
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm rounded-4 placeholder-glow">
                        <div class="card-body p-3">
                            <span class="placeholder col-6"></span>
                            <span class="placeholder col-4"></span>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            @foreach (var role in roles)
            {
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm rounded-4 role-card hover-lift h-100">
                        <div class="card-body d-flex align-items-center p-3">
                            <div class="icon-shape bg-primary-subtle text-primary rounded-3 me-3">
                                <i class="bi bi-shield-lock fs-4"></i>
                            </div>
                            <div>
                                <h6 class="text-uppercase text-muted small fw-bold mb-0">@role.Name</h6>
                                <h4 class="fw-bold mb-0">@role.UserCount <span class="small text-muted fw-normal" style="font-size: 0.7rem;">usuarios</span></h4>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>

    <div class="row g-4">
        @* --- TABLA PRINCIPAL --- *@
        <div class="col-12">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden border-top border-4 border-primary">
                <div class="card-header bg-white py-4 px-4 border-0">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="fw-bold m-0"><i class="bi bi-people-fill me-2"></i>Gestión de Identidades</h5>
                        </div>
                        <div class="col-md-6">
                            <div class="search-box">
                                <i class="bi bi-search text-muted"></i>
                                <input type="text" @bind="searchTerm" @bind:event="oninput" @onkeyup="FiltrarUsuarios" 
                                       class="form-control border-0 bg-light rounded-pill ps-5" placeholder="Filtrar por nombre, email o cargo...">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light-blue text-dark small text-uppercase fw-bold">
                                <tr>
                                    <th class="ps-4 py-3">Operador / Identidad</th>
                                    <th>Nivel de Acceso</th>
                                    <th>Estado Actual</th>
                                    <th>Actividad</th>
                                    <th class="text-end pe-4">Acciones de Control</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (usuarios == null)
                                {
                                    <tr>
                                        <td colspan="5" class="text-center py-5">
                                            <div class="spinner-grow text-primary" role="status"></div>
                                            <p class="text-muted mt-2">Consultando registros...</p>
                                        </td>
                                    </tr>
                                }
                                else if (!usuariosFiltrados.Any())
                                {
                                    <tr>
                                        <td colspan="5" class="text-center py-5">
                                            <i class="bi bi-inbox fs-1 text-muted opacity-25 d-block mb-2"></i>
                                            <p class="text-muted">No se encontraron registros de seguridad.</p>
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var user in usuariosFiltrados)
                                    {
                                        <tr>
                                            <td class="ps-4 py-3">
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-box me-3">
                                                        @(string.IsNullOrEmpty(user.FullName) ? "?" : user.FullName.Substring(0, 1).ToUpper())
                                                    </div>
                                                    <div>
                                                        <div class="fw-bold text-dark lh-1 mb-1">@user.FullName</div>
                                                        <div class="small text-muted">@user.Email</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge rounded-pill bg-role px-3 py-2">
                                                    <i class="bi bi-key-fill me-1"></i> @user.Role
                                                </span>
                                            </td>
                                            <td>
                                                @if (user.IsActive) {
                                                    <span class="status-indicator active">
                                                        <span class="dot"></span> ONLINE / ACTIVO
                                                    </span>
                                                } else {
                                                    <span class="status-indicator blocked">
                                                        <span class="dot"></span> BLOQUEADO
                                                    </span>
                                                }
                                            </td>
                                            <td class="text-muted small">
                                                <i class="bi bi-calendar3 me-1"></i> 
                                                @(user.LastLogin.HasValue ? user.LastLogin.Value.ToString("dd/MM/yyyy HH:mm") : "Sin actividad")
                                            </td>
                                            <td class="text-end pe-4">
                                                <div class="btn-group shadow-sm rounded-3">
                                                    <button class="btn btn-white btn-sm px-3" title="Editar"><i class="bi bi-pencil-square text-primary"></i></button>
                                                    <button class="btn btn-white btn-sm px-3 border-start border-end" @onclick="() => CambiarEstado(user.Id)">
                                                        <i class="bi bi-@(user.IsActive ? "lock text-warning" : "unlock text-success")"></i>
                                                    </button>
                                                    <button class="btn btn-white btn-sm px-3" @onclick="() => EliminarUsuario(user.Id)">
                                                        <i class="bi bi-trash3 text-danger"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* --- MODAL REDISEÑADO --- *@
@if (mostrarModal)
{
    <div class="modal fade show d-block animate__animated animate__fadeInDown" tabindex="-1" style="background-color: rgba(13, 20, 36, 0.8); backdrop-filter: blur(8px);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-2xl rounded-4 overflow-hidden">
                <div class="modal-header bg-primary text-white p-4 border-0" style="background: linear-gradient(135deg, #1a237e 0%, #3f51b5 100%);">
                    <h5 class="modal-title fw-bold"><i class="bi bi-person-plus me-2"></i>NUEVO PERFIL DE ACCESO</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body p-4 bg-white">
                    <EditForm Model="@nuevoUser" OnValidSubmit="GuardarUsuario">
                        <DataAnnotationsValidator />
                        
                        <div class="form-floating mb-3">
                            <InputText @bind-Value="nuevoUser.FullName" class="form-control bg-light border-0" id="nameInput" placeholder="Nombre" />
                            <label for="nameInput" class="text-muted small fw-bold">NOMBRE COMPLETO</label>
                            <ValidationMessage For="@(() => nuevoUser.FullName)" class="text-danger x-small" />
                        </div>

                        <div class="form-floating mb-3">
                            <InputText @bind-Value="nuevoUser.Email" class="form-control bg-light border-0" id="emailInput" placeholder="Email" />
                            <label for="emailInput" class="text-muted small fw-bold">CORREO CORPORATIVO</label>
                            <ValidationMessage For="@(() => nuevoUser.Email)" class="text-danger x-small" />
                        </div>

                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <InputSelect @bind-Value="nuevoUser.Role" class="form-select bg-light border-0" id="roleSelect">
                                        <option value="">Seleccionar...</option>
                                        @if (roles != null) {
                                            @foreach (var r in roles) { <option value="@r.Name">@r.Name</option> }
                                        }
                                    </InputSelect>
                                    <label class="text-muted small fw-bold">NIVEL DE ROL</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <InputText @bind-Value="nuevoUser.Password" type="password" class="form-control bg-light border-0" id="passInput" placeholder="Contraseña" />
                                    <label class="text-muted small fw-bold">CONTRASEÑA TEMPORAL</label>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 d-flex gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-lg w-100 fw-bold border-2 rounded-3" @onclick="CerrarModal">DESCARTAR</button>
                            <button type="submit" class="btn btn-primary btn-lg w-100 fw-bold shadow-lg rounded-3">CONFIRMAR ALTA</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // Mantengo exactamente tu lógica de @code sin simplificar nada 
    // ... (Métodos OnInitializedAsync, CargarDatos, FiltrarUsuarios, etc. tal cual los tienes)
    private List<UserDto>? usuarios;
    private List<UserDto> usuariosFiltrados = new();
    private List<RoleDto>? roles;
    private bool mostrarModal = false;
    private CreateUserDto nuevoUser = new CreateUserDto { EmpresaId = 1 }; 
    private string searchTerm = "";

    protected override async Task OnInitializedAsync() => await CargarDatos();

    private async Task CargarDatos() {
        try {
            usuarios = await Http.GetFromJsonAsync<List<UserDto>>("api/users");
            roles = await Http.GetFromJsonAsync<List<RoleDto>>("api/users/roles");
            FiltrarUsuarios();
        } catch (Exception ex) {
            Console.WriteLine($"Error: {ex.Message}");
            await JS.InvokeVoidAsync("alert", "Error de sincronización.");
        }
    }

    private void FiltrarUsuarios() {
        if (usuarios == null) { usuariosFiltrados = new(); return; }
        var busqueda = searchTerm.ToLower().Trim();
        usuariosFiltrados = string.IsNullOrEmpty(busqueda) 
            ? usuarios.ToList() 
            : usuarios.Where(u => u.FullName.ToLower().Contains(busqueda) || u.Email.ToLower().Contains(busqueda) || u.Role.ToLower().Contains(busqueda)).ToList();
        StateHasChanged();
    }

    private void MostrarModalNuevoUsuario() { nuevoUser = new CreateUserDto { EmpresaId = 1 }; mostrarModal = true; }
    private void CerrarModal() => mostrarModal = false;

    private async Task GuardarUsuario() {
        try {
            var response = await Http.PostAsJsonAsync("api/users", nuevoUser);
            if (response.IsSuccessStatusCode) {
                await JS.InvokeVoidAsync("alert", "Registro completado.");
                CerrarModal();
                await CargarDatos();
            } else {
                var error = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Denegado: {error}");
            }
        } catch (Exception ex) { await JS.InvokeVoidAsync("alert", $"Fallo: {ex.Message}"); }
    }

    private async Task CambiarEstado(string id) {
        var usuario = usuarios?.FirstOrDefault(u => u.Id == id);
        if (usuario == null) return;
        if (!await JS.InvokeAsync<bool>("confirm", $"¿Confirmar cambio de estado para {usuario.FullName}?")) return;
        try {
            var response = await Http.PutAsync($"api/users/{id}/status", null);
            if (response.IsSuccessStatusCode) await CargarDatos();
        } catch (Exception ex) { await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}"); }
    }

    private async Task EliminarUsuario(string id) {
        if (!await JS.InvokeAsync<bool>("confirm", "ADVERTENCIA: ¿ELIMINAR PERMANENTEMENTE?")) return;
        try {
            var response = await Http.DeleteAsync($"api/users/{id}");
            if (response.IsSuccessStatusCode) { await CargarDatos(); await JS.InvokeVoidAsync("alert", "Usuario purgado."); }
        } catch (Exception ex) { await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}"); }
    }
}

<style>
    /* ESTÉTICA ERP INDUSTRIAL PRO */
    .bg-light-blue { background-color: #f8fafc; }
    .hover-lift:hover { transform: translateY(-3px); transition: all 0.2s; }
    
    .icon-shape {
        width: 48px; height: 48px;
        display: flex; align-items: center; justify-content: center;
    }

    .avatar-box {
        width: 42px; height: 42px;
        background: #1a237e; color: white;
        border-radius: 8px; display: flex;
        align-items: center; justify-content: center;
        font-weight: bold; font-size: 1.1rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .bg-role { background-color: #f1f5f9; color: #334155; border: 1px solid #e2e8f0; font-size: 0.75rem; font-weight: 700; }

    /* Buscador Moderno */
    .search-box { position: relative; }
    .search-box i { position: absolute; left: 18px; top: 12px; }

    /* Indicadores de Estado con Pulsación */
    .status-indicator { font-size: 0.7rem; font-weight: 800; display: flex; align-items: center; }
    .status-indicator .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
    .status-indicator.active { color: #10b981; }
    .status-indicator.active .dot { background-color: #10b981; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2); }
    .status-indicator.blocked { color: #ef4444; }
    .status-indicator.blocked .dot { background-color: #ef4444; }

    /* Botonera White */
    .btn-white { background: white; border: 1px solid #e2e8f0; transition: all 0.2s; }
    .btn-white:hover { background: #f8fafc; }

    .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
    .x-small { font-size: 0.7rem; }
</style>